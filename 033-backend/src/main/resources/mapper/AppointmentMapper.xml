<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiaou.wedding.mapper.AppointmentMapper">

    <resultMap id="BaseResultMap" type="com.xiaou.wedding.entity.Appointment">
        <id property="id" column="id"/>
        <result property="customerId" column="customer_id"/>
        <result property="appointmentType" column="appointment_type"/>
        <result property="packageId" column="package_id"/>
        <result property="photographerId" column="photographer_id"/>
        <result property="studioId" column="studio_id"/>
        <result property="appointmentDate" column="appointment_date"/>
        <result property="timeSlot" column="time_slot"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findById" resultMap="BaseResultMap">
        SELECT * FROM appointment WHERE id = #{id}
    </select>

    <select id="list" resultMap="BaseResultMap">
        SELECT * FROM appointment
        WHERE 1=1
        <if test="customerId != null">AND customer_id = #{customerId}</if>
        <if test="date != null and date != ''">AND appointment_date = #{date}</if>
        ORDER BY appointment_date DESC, time_slot ASC
    </select>

    <select id="countConflict" resultType="int">
        SELECT COUNT(1) FROM appointment
        WHERE appointment_date = #{appointmentDate}
          AND time_slot = #{timeSlot}
          AND (
                (photographer_id IS NOT NULL AND photographer_id = #{photographerId})
                OR (studio_id IS NOT NULL AND studio_id = #{studioId})
              )
          AND status IN ('PENDING','CONFIRMED')
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO appointment (customer_id, appointment_type, package_id, photographer_id, studio_id, appointment_date, time_slot, status, remark, created_by)
        VALUES (#{customerId}, #{appointmentType}, #{packageId}, #{photographerId}, #{studioId}, #{appointmentDate}, #{timeSlot}, #{status}, #{remark}, #{createdBy})
    </insert>

    <update id="update">
        UPDATE appointment
        <set>
            <if test="appointmentType != null">appointment_type = #{appointmentType},</if>
            <if test="packageId != null">package_id = #{packageId},</if>
            <if test="photographerId != null">photographer_id = #{photographerId},</if>
            <if test="studioId != null">studio_id = #{studioId},</if>
            <if test="appointmentDate != null">appointment_date = #{appointmentDate},</if>
            <if test="timeSlot != null">time_slot = #{timeSlot},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        WHERE id = #{id}
    </update>
</mapper>
